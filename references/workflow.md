# 法律文件脱敏处理 - 详细工作流程

## 一、脱敏流程

### 步骤1：上传文件

1. 打开 `assets/index.html`
2. 拖拽docx文件到上传区域，或点击选择文件
3. 文件自动解析，显示原文内容

### 步骤2：自动识别

系统自动应用默认规则进行识别：

| 类型 | 识别规则示例 | 默认替换 |
|------|-------------|---------|
| 公司名称 | `XXX公司`、`XXX有限公司` | 【买方公司A】、【卖方公司B】 |
| 日期 | `2024年3月15日`、`2024-03-15` | 【日期1】、【日期2】 |
| 价格 | `人民币50000元`、`$500` | 【单价】、【总价】 |
| 文件名 | `合同编号2024-001` | 【文件编号】 |
| 项目名 | `智能制造系统集成项目` | 【项目名称】 |

### 步骤3：手动编辑

在预览界面可以：

1. **手动选择文本添加脱敏项**
   - 在原文预览区选中要脱敏的文本
   - 点击"➕ 手动添加"按钮（或自动弹窗）
   - 在弹窗中选择脱敏类型
   - 确认添加

2. **删除脱敏项**
   - 点击脱敏项列表中的删除按钮
   - 或在预览区域点击高亮文本选择"取消脱敏"

3. **修改替换文本**
   - 双击脱敏项列表中的替换文本
   - 输入自定义替换内容

4. **调整类型**
   - 修改脱敏项的类型分类
   - 系统自动更新替换文本

### 步骤4：白名单/黑名单管理

白名单/黑名单机制允许精确控制特定内容的脱敏行为。

1. **打开管理界面**
   - 点击操作栏中的"📋 白名单/黑名单"按钮
   - 弹出管理窗口

2. **白名单管理（不脱敏）**
   - 左侧区域为白名单
   - 输入内容后点击"添加"
   - 该内容将不会被脱敏
   - 点击列表项的"删除"可移除

3. **黑名单管理（强制脱敏）**
   - 右侧区域为黑名单
   - 输入内容后点击"添加"
   - 该内容将被强制脱敏为【敏感信息】
   - 点击列表项的"删除"可移除

4. **保存设置**
   - 点击"保存"按钮应用设置
   - 数据保存在浏览器 localStorage 中
   - 在所有文件间共享

**使用场景**：
- 白名单：通用公司名称、公开日期、公开联系方式等
- 黑名单：特殊项目代号、不规则代码、内部术语等

### 步骤5：导出结果

导出以下文件：

1. **脱敏文件.docx** (仅前端)
   - 保留原格式的脱敏文档
   - 简单文本替换，无需Python

2. **脱敏规则JSON** (`rules-export.json`)
   - 包含所有脱敏项的配置
   - 可用于批量处理同类文件

3. **替换比对.md** (`mapping.md`)
   - 表格形式的替换明细
   - 用于后续还原操作

4. **脱敏预览.md** (仅前端)
   - HTML预览的markdown版本
   - 可用于快速分享查看

### 步骤6：生成脱敏docx（可选，需Python脚本）

```bash
python scripts/redact.py input.docx rules-export.json -o output.docx
```

### 步骤7：调试模式（可选）

启用调试模式可以查看详细的脱敏处理日志。

1. **启用调试模式**
   - 勾选"🐛 启用调试模式"复选框
   - 调试面板会显示在操作栏下方

2. **查看调试日志**
   - 浏览器按F12打开开发者工具
   - 切换到Console标签页
   - 查看详细匹配和处理日志

3. **导出调试日志**
   - 点击调试面板右上角的"📥 导出日志"按钮
   - 保存为带时间戳的txt文件

**调试日志内容**：
- 规则匹配过程
- 白名单/黑名单过滤结果
- 替换操作详情
- 错误和警告信息

## 二、还原流程

### 应用场景

将脱敏后的文件交由外部（人工/AI）审核后，使用比对词将【X】标记还原为原文。

**重要**：还原功能会**保留文档中的修订、批注等审核痕迹**。

### 方式1：使用HTML工具（推荐）

1. 打开 `assets/index.html`
2. 选择"还原模式"
3. 上传审核稿（带修订、批注的docx文件）
4. 粘贴比对.md内容
5. 点击"执行还原"
6. 自动下载还原后的文件（保留审核痕迹）

### 方式2：使用Python脚本

```bash
python scripts/restore.py redacted.docx mapping.md -o restored.docx
```

**Python还原特性**：
- runs级别替换，精确保留格式
- 自动保留文档中的修订、批注等痕迹
- 支持跨runs的文本替换

### 比对.md格式

比对.md文件格式如下：

```markdown
# 脱敏内容替换比对

**文件**: 合同.docx
**生成时间**: 2026-02-06 14:30:00
**脱敏项总数**: 18

## 替换明细

| 序号 | 原文 | 替换 | 类型 |
|------|------|------|------|
| 1 | 示例公司A有限公司 | 【买方公司A】 | 组织机构 |
| 2 | 2024年3月15日 | 【日期1】 | 日期 |
| 3 | 人民币500,000元 | 【金额1】 | 价格/金额 |
```

### 审核稿还原工作流程

```
┌─────────────────┐
│  1. 脱敏原文件   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  2. 导出比对.md  │  ← 用户自己保管，不交给审核方
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  3. 交付脱敏稿   │  →  交给外部AI/人工审核
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  4. 返回审核稿   │  ← 包含修订、批注等痕迹
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  5. 使用比对词   │
│     执行还原     │  → 保留审核痕迹，还原【X】
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  6. 获得还原稿   │  ← 含原文+审核痕迹
└─────────────────┘
```

## 三、上下文敏感替换

系统自动识别合同角色：

```javascript
// 上下文规则示例
{
  "trigger": "买方|甲方|委托方|发包方",
  "category": "buyer",
  "prefix": "买方"
},
{
  "trigger": "卖方|乙方|受托方|承包方",
  "category": "seller",
  "prefix": "卖方"
}
```

**示例效果**：

| 原文 | 上下文 | 替换结果 |
|------|--------|---------|
| 示例公司A有限公司 | 甲方（买方） | 【买方公司A】 |
| 示例公司B股份有限公司 | 乙方（卖方） | 【卖方公司B】 |
| 2024年3月15日 | 签约日期 | 【签约日期】 |
| 人民币50000元 | 合同总价 | 【合同总价】 |

## 四、规则自定义

### 编辑规则文件

编辑 `data/default-rules.json` 添加自定义规则：

```json
{
  "id": "custom_rule",
  "name": "自定义规则",
  "category": "custom",
  "patterns": [
    "正则表达式1",
    "正则表达式2"
  ],
  "replacement": "【替换文本】",
  "enabled": true,
  "priority": 10
}
```

### 导入/导出规则

- **导出**: 点击"导出规则"按钮保存当前规则
- **导入**: 点击"导入规则"加载自定义规则文件

## 五、注意事项

1. **格式保留**: Python脚本生成的docx文件会保留原文格式
2. **表格处理**: 表格中的内容也会被识别和脱敏
3. **批量处理**: 导出的规则JSON可用于批量处理多个类似文件
4. **数据安全**: 所有处理均在本地完成，不会上传到任何服务器
