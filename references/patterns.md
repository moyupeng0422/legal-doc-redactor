# 脱敏规则模式库 (v1.1.0)

## 版本历史

- **v1.1.0 (2026-02-05)**: 价格支持千万元单位、拆分代码类型、添加前缀依赖和useCaptureGroup、添加contextRules和priceContextRules、增强公司名规则
- **v1.0.0 (2026-02-03)**: 初始版本

---

## 内置规则类型

### 1. 联系邮箱 (email)

#### 规则配置
```json
{
  "id": "email",
  "name": "联系邮箱",
  "category": "email",
  "patterns": [
    "[\\w\\-\\.]+@[\\w\\-]+(\\.[\\w\\-]+)+",
    "邮箱[：:]?\\s*[\\w\\-\\.]+@[\\w\\-]+(\\.[\\w\\-]+)+"
  ],
  "replacement": "【邮箱${index}】",
  "priority": 10
}
```

#### 识别示例

| 原文 | 匹配 | 替换 |
|------|------|------|
| user@example.com | ✓ | 【邮箱1】 |
| 邮箱：test@163.com | ✓ | 【邮箱2】 |

---

### 2. 身份证号 (id_card)

#### 规则配置
```json
{
  "id": "id_card",
  "name": "身份证号",
  "category": "id_card",
  "patterns": [
    "[1-9]\\d{5}(18|19|20)\\d{2}(0[1-9]|1[0-2])(0[1-9]|[12]\\d|3[01])\\d{3}[0-9Xx]"
  ],
  "replacement": "【身份证号${index}】",
  "priority": 10
}
```

#### 识别示例

| 原文 | 匹配 | 替换 |
|------|------|------|
| 110101199001011234 | ✓ | 【身份证号1】 |

---

### 3. 公司名称 (organization)

#### 规则配置
```json
{
  "id": "company_name",
  "name": "公司名称",
  "category": "organization",
  "patterns": [
    "(^|[\\s，。；：、\\(（\\[\\{「『])([\\u4e00-\\u9fa5]{2,20})(有限公司|股份公司|集团公司|控股公司|公司)",
    "([^管理本其各该他她它])公司(?!管理|制度|章程|行为|财产|业务|范围|住所|地址|内|中|上)",
    "([\\u4e00-\\u9fa5]{2,20})(研究院|研究所|实验室|技术中心|大学|学院)"
  ],
  "replacement": "【公司${index}】",
  "contextSensitive": true,
  "priority": 10
}
```

#### 识别示例

| 原文 | 匹配 | 替换 |
|------|------|------|
| 示例公司A有限公司 | ✓ | 【公司1】 |
| 示例公司B股份有限公司 | ✓ | 【公司2】 |

#### 技术要点
- **边界检查**: `(^|[\\s，。；：、\\(（\\[\\{「『])` 确保不在词语中间匹配
- **负向前瞻**: `(?!管理|制度|章程|行为|财产|业务|范围|住所|地址|内|中|上)` 排除描述性语句

---

### 4. 日期 (date)

#### 规则配置
```json
{
  "id": "date",
  "name": "日期",
  "category": "date",
  "patterns": [
    "\\d{4}\\s{0,2}年\\s{0,2}\\d{1,2}\\s{0,2}月\\s{0,2}\\d{1,2}\\s{0,2}日",
    "\\d{4}-\\d{1,2}-\\d{1,2}",
    "\\d{4}/\\d{1,2}/\\d{1,2}",
    "\\d{1,2}月\\d{1,2}日"
  ],
  "replacement": "【日期${index}】",
  "priority": 8
}
```

#### 识别示例

| 原文 | 匹配 | 替换 |
|------|------|------|
| 2015年1月12日 | ✓ | 【日期1】 |
| 2024-12-31 | ✓ | 【日期2】 |
| 2025/01/01 | ✓ | 【日期3】 |
| 3月15日 | ✓ | 【日期4】 |

---

### 5. 价格/金额 (price)

#### 规则配置
```json
{
  "id": "price",
  "name": "价格/金额",
  "category": "price",
  "patterns": [
    "人民币\\s*\\d+(,\\d{3})*(\\.\\d+)?[万千万元]",
    "\\d+(,\\d{3})*(\\.\\d+)?[万千万元]",
    "RMB\\s*\\d+(,\\d{3})*(\\.\\d+)?",
    "\\$\\s*\\d+(,\\d{3})*(\\.\\d+)?"
  ],
  "replacement": "【金额${index}】",
  "priority": 9
}
```

#### 识别示例

| 原文 | 匹配 | 替换 |
|------|------|------|
| 人民币2000万元 | ✓ | 【金额1】 |
| 1020万元 | ✓ | 【金额2】 |
| RMB 50,000 | ✓ | 【金额3】 |
| $1000 | ✓ | 【金额4】 |

#### 技术要点
- **边界检查**: 防止部分匹配（如"1100万元"被匹配为"100万元"）
- **千万元支持**: `[万千万元]` 匹配千/万/元单位

---

### 6. 人名 (person_name)

#### 规则配置
```json
{
  "id": "person_name",
  "name": "人名",
  "category": "person_name",
  "useCaptureGroup": true,
  "patterns": [
    "(?:甲方|乙方|丙方|丁方|戊方|己方|原告方|被告方|委托方|受托方|发包方|承包方|采购方|供应商|卖方|买方|出租方|承租方|转让方|受让方|投资方|被投资方|借款人|贷款人|保证人|抵押人|出质人|收款人|付款人|债务人|债权人|申请人|被申请人)[：:]\\s*([\\u4e00-\\u9fa5]{2,20})(?=\\s|$|[，。；：])"
  ],
  "replacement": "【人员${index}】",
  "contextSensitive": true,
  "priority": 5
}
```

#### 识别示例

| 原文 | 匹配 | 替换 |
|------|------|------|
| 甲方：示例人员A | ✓ | 【人员1】 |
| 丙方：示例人员B | ✓ | 【人员2】 |

#### 技术要点
- **useCaptureGroup**: 只捕获前缀后的名称，不包含前缀本身
- **通用词排除**: 自动排除"签署时间"、"法定代表人"等通用词汇

---

### 7. 代码类型

#### 7.1 统一社会信用代码 (credit_code)

```json
{
  "id": "credit_code",
  "name": "统一社会信用代码",
  "category": "credit_code",
  "useCaptureGroup": true,
  "patterns": [
    "统一社会信用代码[：:]\\s*([0-9A-HJ-NPQRTUWXY]{15,18})"
  ],
  "replacement": "【代码-统一社会信用代码${index}】",
  "priority": 9
}
```

#### 7.2 组织机构代码 (org_code)

```json
{
  "id": "org_code",
  "name": "组织机构代码",
  "category": "org_code",
  "useCaptureGroup": true,
  "patterns": [
    "组织机构代码[：:]\\s*(\\d{8}-?[0-9X])"
  ],
  "replacement": "【代码-组织机构代码${index}】",
  "priority": 9
}
```

#### 7.3 专利申请号 (patent_code)

```json
{
  "id": "patent_code",
  "name": "专利申请号",
  "category": "patent_code",
  "useCaptureGroup": true,
  "patterns": [
    "(?:专利|商标|著作权)申请号[：:]\\s*([A-Z0-9\\.]+)"
  ],
  "replacement": "【代码-专利申请号${index}】",
  "priority": 9
}
```

#### 7.4 文件编号 (file_code)

```json
{
  "id": "file_code",
  "name": "文件编号",
  "category": "file_code",
  "useCaptureGroup": true,
  "patterns": [
    "合同编号[：:]\\s*([A-Z0-9\\-]+)",
    "文件编号[：:]\\s*([A-Z0-9\\-]+)",
    "文件号[：:]\\s*([A-Z0-9\\-]+)"
  ],
  "replacement": "【代码-文件编号${index}】",
  "priority": 7
}
```

#### 识别示例

| 原文 | 匹配 | 替换 |
|------|------|------|
| 统一社会信用代码：90000000000000000X | ✓ | 【代码-统一社会信用代码1】 |
| 专利申请号：202310123456.7 | ✓ | 【代码-专利申请号1】 |
| 合同编号：HT-2024-001 | ✓ | 【代码-文件编号1】 |

#### 技术要点
- **前缀依赖**: 所有代码类型必须带前缀才能识别
- **useCaptureGroup**: 只捕获前缀后的代码，不包含前缀本身

---

### 8. 联系电话 (phone)

#### 规则配置
```json
{
  "id": "phone",
  "name": "联系电话",
  "category": "phone",
  "useCaptureGroup": true,
  "patterns": [
    "联系电话[：:]\\s*(1[3-9]\\d{9})",
    "联系电话[：:]\\s*(0\\d{2,3}-?\\d{7,8})",
    "联系电话[：:]\\s*\\((0\\d{2,3})\\)\\d{7,8}",
    "电话[：:]\\s*(1[3-9]\\d{9})",
    "电话[：:]\\s*(0\\d{2,3}-?\\d{7,8})",
    "手机[：:]\\s*(1[3-9]\\d{9})"
  ],
  "replacement": "【电话${index}】",
  "priority": 8
}
```

#### 识别示例

| 原文 | 匹配 | 替换 |
|------|------|------|
| 联系电话：138xxxx5678 | ✓ | 【电话1】 |
| 电话：010-12345678 | ✓ | 【电话2】 |
| 手机：13912345678 | ✓ | 【电话3】 |

#### 技术要点
- **前缀依赖**: 必须带"联系电话："/"电话："/"手机："等前缀
- **useCaptureGroup**: 只捕获前缀后的号码，不包含前缀本身

---

### 9. 项目名称 (project_name)

#### 规则配置
```json
{
  "id": "project_name",
  "name": "项目名称",
  "category": "project_name",
  "patterns": [
    "([\\u4e00-\\u9fa5]{2,10})(项目|工程|系统|平台|计划)",
    "([\\u4e00-\\u9fa5]{2,10})(研发|建设|实施)项目"
  ],
  "replacement": "【项目${index}】",
  "priority": 6
}
```

#### 识别示例

| 原文 | 匹配 | 替换 |
|------|------|------|
| 智能制造系统集成项目 | ✓ | 【项目1】 |
| 数字化转型工程 | ✓ | 【项目2】 |

---

### 10. 地址 (address)

#### 规则配置
```json
{
  "id": "address",
  "name": "地址",
  "category": "address",
  "patterns": [
    "(地址|住所|住址|注册地址|办公地址|住所地)[：:]\\s*([\\u4e00-\\u9fa5\\w\\d\\s]+)",
    "([\\u4e00-\\u9fa5]{2,4}市[\\u4e00-\\u9fa5]{1,4}区[\\u4e00-\\u9fa5\\d]+(?:路|街|道|大道)(?:\\d+|[\\u4e00-\\u9fa5]+)楼\\d{1,4}-\\d{1,4})"
  ],
  "replacement": "【地址${index}】",
  "priority": 4
}
```

#### 识别示例

| 类型 | 原文 | 匹配 | 替换 |
|------|------|------|------|
| 带前缀 | 地址：示例省示例市示例区示例街道1号示例大厦3楼 | ✓ | 【地址1】 |
| 带前缀 | 住所地：示例直辖市示例区示例路2号示例大厦1号楼12单元 | ✓ | 【地址2】 |
| 数字楼号 | XX市XX区XX路XX号XX楼XX-XX | ✓ | 【地址3】 |
| 汉字楼号 | XX市XX区XX路XX综合楼XXXX-X | ✓ | 【地址4】 |

---

### 11. 银行账号 (bank_account)

#### 规则配置
```json
{
  "id": "bank_account",
  "name": "银行账号",
  "category": "bank_account",
  "useCaptureGroup": true,
  "patterns": [
    "账号[：:]\\s*(\\d{16,19})",
    "银行账号[：:]\\s*(\\d{16,19})",
    "账户[：:]\\s*(\\d{16,19})",
    "\\d{4}\\s+\\d{4}\\s+\\d{4}\\s+\\d{4}(?:\\s+\\d{4})?"
  ],
  "replacement": "【账号${index}】",
  "priority": 9
}
```

#### 识别示例

| 原文 | 匹配 | 替换 |
|------|------|------|
| 账号：6222021234567890123 | ✓ | 【账号1】 |
| 银行账号：6228 4800 1234 5678 901 | ✓ | 【账号2】 |
| 6217 0032 0000 1234 567 | ✓ | 【账号3】 |

#### 技术要点
- **前缀依赖**: 必须带"账号："/"银行账号："/"账户："等前缀，或使用标准格式（每4位空格分隔）
- **useCaptureGroup**: 只捕获前缀后的账号，不包含前缀本身
- **长度范围**: 16-19位数字

---

### 12. 案号 (case_number)

#### 规则配置
```json
{
  "id": "case_number",
  "name": "案号",
  "category": "case_number",
  "useCaptureGroup": true,
  "patterns": [
    "([（(]\\d{4}[)）][^民刑行知赔]{1,6}?(?:民|刑|行|知|赔)[^初终再监执字第]{0,5}?\\d+[号])(?:[，。、,;．.？])?",
    "(\\(\\d{4}\\)[^\"]{2,8}?\\d+号)(?:[，。、,;．.？])?",
    "(（\\d{4}）[^\"]{2,8}?\\d+号)(?:[，。、,;．.？])?",
    "(\\d{4}年（[A-Z]{1,5}）第\\d+号)(?:[，。、,;．.？])?",
    "(Case No\\.(?:\\s+[\\d:]+-cv-)?\\d+)(?:[，。、,;．.？])?",
    "((?:Civil Action) No\\.\\s+[\\d:]+-cv-\\d+)(?:[，。、,;．.？])?",
    "(\\[\\d{4}\\]\\s+[A-Z]{1,4}\\s+\\d+\\s+\\([A-Z]+\\))(?:[，。、,;．.？])?",
    "(Az\\.:\\s+\\d+[A-Z]?\\s+\\d+/\\d{2,4})(?:[，。、,;．.？])?",
    "(RG\\s+\\d+/\\d+)(?:[，。、,;．.？])?"
  ],
  "replacement": "【案号${index}】",
  "priority": 9
}
```

#### 识别示例

| 原文 | 匹配 | 替换 |
|------|------|------|
| （2024）京01民初123号 | ✓ | 【案号1】 |
| (2024)粤知民终456号 | ✓ | 【案号2】 |
| [2024]最高法民再78号 | ✓ | 【案号3】 |
| Case No. 2024-cv-12345 | ✓ | 【案号4】 |

#### 技术要点
- **useCaptureGroup**: 只捕获案号本身，不包含后缀标点
- **多格式支持**: 中文案号、英文案号、国际案号
- **边界检查**: 后缀标点符号不计入匹配内容

---

## 上下文规则配置

### 合同方识别 (contextRules)

```json
{
  "contextRules": [
    {
      "id": "party_a",
      "name": "甲方/买方",
      "trigger": "甲方|买方|委托方|发包方|采购方",
      "category": "buyer",
      "prefix": "买方"
    },
    {
      "id": "party_b",
      "name": "乙方/卖方",
      "trigger": "乙方|卖方|受托方|承包方|供应商",
      "category": "seller",
      "prefix": "卖方"
    },
    {
      "id": "party_c",
      "name": "丙方/第三方",
      "trigger": "丙方|第三方|担保方",
      "category": "third_party",
      "prefix": "第三方"
    }
  ]
}
```

### 金额类型识别 (priceContextRules)

```json
{
  "priceContextRules": [
    {
      "trigger": "合同总价|总金额|交易价格|成交价格",
      "type": "合同总价"
    },
    {
      "trigger": "单价|单位价格",
      "type": "单价"
    },
    {
      "trigger": "预付款|首付款|定金",
      "type": "预付款"
    },
    {
      "trigger": "尾款|余款|最后一期款",
      "type": "尾款"
    },
    {
      "trigger": "违约金|赔偿金|补偿金",
      "type": "违约金"
    }
  ]
}
```

---

## 规则优先级

| 优先级 | 规则类型 | 说明 |
|--------|----------|------|
| 10 | email, id_card, organization | 最高优先级，避免被其他规则误匹配 |
| 9 | price, credit_code, org_code, patent_code | 高优先级 |
| 8 | date, phone | 较高优先级 |
| 7 | file_code | 中高优先级 |
| 6 | project_name | 中等优先级 |
| 5 | person_name | 较低优先级 |
| 4 | address | 最低优先级 |

---

## useCaptureGroup 技术说明

### 什么是 useCaptureGroup？

当 `useCaptureGroup: true` 时，匹配结果使用正则表达式的第一个捕获组（`match[1]`）而不是完整匹配（`match[0]`）。

### 示例

**模式**: `"联系电话[：:]\\s*(1[3-9]\\d{9})"`

| 输入 | 完整匹配 match[0] | 捕获组 match[1] | 使用捕获组后 |
|------|-------------------|-----------------|--------------|
| 联系电话：13812345678 | 联系电话：13812345678 | 13812345678 | 13812345678 |

**好处**: 前缀（"联系电话："）不会被包含在脱敏文字中，避免前缀本身被替换。

---

## 自定义规则模板

### 添加新规则

```json
{
  "id": "your_rule_id",
  "name": "规则名称",
  "category": "category_name",
  "enabled": true,
  "patterns": [
    "正则表达式1",
    "正则表达式2"
  ],
  "replacement": "【替换文本】",
  "contextSensitive": false,
  "priority": 5,
  "description": "规则说明",
  "useCaptureGroup": false
}
```

### 正则表达式编写技巧

1. **中文匹配**: `[\\u4e00-\\u9fa5]`
2. **数字匹配**: `\\d+`
3. **可选匹配**: `(pattern)?`
4. **分组匹配**: `(pattern)` 用于提取
5. **或匹配**: `(a|b|c)`
6. **量词**: `*` (0+), `+` (1+), `?` (0/1), `{n,m}` (n到m次)
7. **边界检查**: `(^|[\\s，。；：、\\(（\\[\\{「『])`
8. **负向前瞻**: `(?!pattern)` 排除特定匹配

---

## 白名单/黑名单机制

### 机制说明

白名单/黑名单机制允许用户精确控制特定内容的脱敏行为，弥补自动识别的不足。

### 白名单（不脱敏）

**用途**: 某些内容虽然匹配了脱敏规则，但用户希望保留原文。

**示例场景**:
- "某某公司"是通用公司名称，不希望脱敏
- "2024年3月15日"是公开的签约日期，无需脱敏
- 某些特定的邮箱地址是公开联系方式

**操作方式**:
1. 点击"📋 白名单/黑名单"按钮
2. 在左侧白名单区域输入内容并添加
3. 该内容将不会被脱敏

### 黑名单（强制脱敏）

**用途**: 某些内容没有匹配到规则，但用户希望强制脱敏。

**示例场景**:
- 特定的内部项目代号
- 某些特殊的代码格式
- 不规则的人名/地址表述

**操作方式**:
1. 点击"📋 白名单/黑名单"按钮
2. 在右侧黑名单区域输入内容并添加
3. 该内容将被强制脱敏为【敏感信息】

### 优先级规则

脱敏检查的优先级顺序：

1. **白名单检查** - 如果在白名单中，跳过脱敏
2. **黑名单检查** - 如果在黑名单中，强制脱敏
3. **规则匹配** - 应用默认脱敏规则

### 数据持久化

白名单/黑名单数据保存在浏览器的 localStorage 中：

- `redaction_whitelist`: 白名单数据（JSON数组）
- `redaction_blacklist`: 黑名单数据（JSON数组）

**数据格式**:
```json
["示例公司A", "2024年3月15日", "公开邮箱@example.com"]
```

**跨文件共享**: 白名单/黑名单在所有使用该工具的文件间共享。

### UI操作流程

1. 打开 `assets/index.html`
2. 上传文件后，点击操作栏中的"📋 白名单/黑名单"按钮
3. 在弹窗中管理白名单和黑名单：
   - 左侧：🟢 白名单（不脱敏）
   - 右侧：⚫ 黑名单（强制脱敏）
4. 点击"保存"按钮应用设置

### 调试模式

启用调试模式后，系统会在控制台输出详细的匹配和过滤日志，帮助用户理解为什么某些内容被脱敏或跳过。

**启用方式**: 勾选"🐛 启用调试模式"复选框

**查看日志**:
- 浏览器按F12打开开发者工具
- 切换到Console标签页
- 查看详细调试信息

**导出日志**: 点击"📥 导出日志"按钮，将调试日志保存为txt文件。
